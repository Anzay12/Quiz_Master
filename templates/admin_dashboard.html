{% extends "base.html" %}

{% block title %}Admin Dashboard - Quiz Master{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css', v=1) }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Include Admin Navigation -->
    {% include 'includes/admin_nav.html' %}

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="subjects-tab" data-bs-toggle="tab" data-bs-target="#subjects" type="button" role="tab">
                <i class="fas fa-book me-1"></i> Subject Management
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                <i class="fas fa-users me-1"></i> User Management
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="adminTabContent">
        <!-- Subject Management Tab -->
        <div class="tab-pane fade show active" id="subjects" role="tabpanel">
            <div class="card">
                <div>
                    <div class="search-box">
                        <input type="text" id="subjectSearch" class="form-control" placeholder="Search subjects and chapters...">
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <a href="{{ url_for('add_subject') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i> Add New Subject
                        </a>
                    </div>
                    {% if subjects %}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Subject Name</th>
                                        <th>Description</th>
                                        <th>Chapters</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="subjectTableBody">
                                    {% for subject in subjects %}
                                    <tr class="subject-row" data-subject-name="{{ subject.name.lower() }}" data-subject-desc="{{ subject.description.lower() }}">
                                        <td class="subject-name">{{ subject.name }}</td>
                                        <td class="subject-desc">{{ subject.description }}</td>
                                        <td>
                                            {% if subject.chapters %}
                                                <ul class="list-unstyled mb-0">
                                                    {% for chapter in subject.chapters %}
                                                    <li class="mb-2 chapter-row" data-chapter-name="{{ chapter.name.lower() }}">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="chapter-name">{{ chapter.name }}</span>
                                                            <div>
                                                                <a href="{{ url_for('edit_chapter', chapter_id=chapter.id) }}" 
                                                                   class="btn btn-sm btn-warning me-1">Edit</a>
                                                                <form action="{{ url_for('delete_chapter', chapter_id=chapter.id) }}" 
                                                                      method="POST" 
                                                                      style="display: inline;">
                                                                    <button type="submit" 
                                                                            class="btn btn-sm btn-danger"
                                                                            onclick="return confirm('Are you sure you want to delete this chapter?')">
                                                                        Delete
                                                                    </button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p class="text-muted mb-0">No chapters available.</p>
                                            {% endif %}
                                            <a href="{{ url_for('add_chapter', subject_id=subject.id) }}" 
                                               class="btn btn-sm btn-success mt-2">
                                                <i class="fas fa-plus me-1"></i> Add Chapter
                                            </a>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('edit_subject', subject_id=subject.id) }}" 
                                               class="btn btn-warning">Edit</a>
                                            <form action="{{ url_for('delete_subject', subject_id=subject.id) }}" 
                                                  method="POST" 
                                                  style="display: inline;">
                                                <button type="submit" 
                                                        class="btn btn-danger"
                                                        onclick="return confirm('Are you sure you want to delete this subject? This will also delete all associated chapters and quizzes.')">
                                                    Delete
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No subjects available. Add your first subject to get started!</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- User Management Tab -->
        <div class="tab-pane fade" id="users" role="tabpanel">
            <div class="card">
                <div>
                    <h5 class="mb-0">search User</h5>
                    <div class="search-box">
                        <input type="text" id="userSearch" class="form-control" placeholder="Search users...">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Qualification</th>
                                    <th>Date of Birth</th>
                                    <th>Quiz Attempts</th>
                                    <th>Average Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                {% for user in users %}
                                {% if not user.is_admin %}
                                <tr class="user-row" 
                                    data-name="{{ user.full_name.lower() }}"
                                    data-email="{{ user.username.lower() }}"
                                    data-qualification="{{ user.qualification.lower() }}">
                                    <td class="user-name">{{ user.full_name }}</td>
                                    <td class="user-email">{{ user.username }}</td>
                                    <td class="user-qualification">{{ user.qualification }}</td>
                                    <td>{{ user.dob.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ user.quiz_attempts|length }}</td>
                                    <td>
                                        {% if user.quiz_attempts %}
                                            {% set total_score = namespace(val=0) %}
                                            {% set total_questions = namespace(val=0) %}
                                            {% for attempt in user.quiz_attempts %}
                                                {% set total_score.val = total_score.val + attempt.score %}
                                                {% set total_questions.val = total_questions.val + attempt.total_questions %}
                                            {% endfor %}
                                            {% if total_questions.val > 0 %}
                                                {{ "%.1f"|format((total_score.val / total_questions.val) * 100) }}%
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form action="{{ url_for('delete_user', user_id=user.id) }}" 
                                              method="POST" 
                                              style="display: inline;">
                                            <button type="submit" 
                                                    class="btn btn-sm btn-danger"
                                                    onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.')">
                                                Delete
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tabs
    var triggerTabList = [].slice.call(document.querySelectorAll('#adminTabs button'))
    triggerTabList.forEach(function(triggerEl) {
        new bootstrap.Tab(triggerEl)
    });

    // Subject and Chapter Search
    const subjectSearch = document.getElementById('subjectSearch');
    subjectSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const subjectRows = document.querySelectorAll('.subject-row');
        const chapterRows = document.querySelectorAll('.chapter-row');

        subjectRows.forEach(row => {
            const subjectName = row.dataset.subjectName;
            const subjectDesc = row.dataset.subjectDesc;
            const matches = subjectName.includes(searchTerm) || subjectDesc.includes(searchTerm);
            
            row.style.display = matches ? '' : 'none';
            
            if (matches) {
                highlightText(row.querySelector('.subject-name'), searchTerm);
                highlightText(row.querySelector('.subject-desc'), searchTerm);
            }

            // Show/hide chapters based on search
            const chapterContainer = row.querySelector('ul');
            if (chapterContainer) {
                chapterContainer.style.display = matches ? '' : 'none';
            }
        });

        chapterRows.forEach(row => {
            const chapterName = row.dataset.chapterName;
            const matches = chapterName.includes(searchTerm);
            
            row.style.display = matches ? '' : 'none';
            
            if (matches) {
                highlightText(row.querySelector('.chapter-name'), searchTerm);
            }
        });
    });

    // User Search
    const userSearch = document.getElementById('userSearch');
    userSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const userRows = document.querySelectorAll('.user-row');

        userRows.forEach(row => {
            const name = row.dataset.name;
            const email = row.dataset.email;
            const qualification = row.dataset.qualification;
            const matches = name.includes(searchTerm) || 
                          email.includes(searchTerm) || 
                          qualification.includes(searchTerm);
            
            row.style.display = matches ? '' : 'none';
            
            if (matches) {
                highlightText(row.querySelector('.user-name'), searchTerm);
                highlightText(row.querySelector('.user-email'), searchTerm);
                highlightText(row.querySelector('.user-qualification'), searchTerm);
            }
        });
    });

    // Helper function to highlight matching text
    function highlightText(element, searchTerm) {
        if (!element || !searchTerm) return;
        
        const text = element.textContent;
        const regex = new RegExp(`(${searchTerm})`, 'gi');
        element.innerHTML = text.replace(regex, '<mark>$1</mark>');
    }
});
</script>
{% endblock %}

{% endblock %}